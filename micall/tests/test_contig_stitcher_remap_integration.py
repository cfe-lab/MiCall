"""
Integration tests for contig_stitcher with remap step.

These tests verify that the contig stitcher correctly reads and uses
remap_counts.csv files generated by the actual remap step.
"""

import csv
import os
import pytest
from io import StringIO

from micall.core import remap
from micall.core import contig_stitcher as stitcher
from micall.tests.test_fasta_to_csv import check_hcv_db, DEFAULT_DATABASE
from micall.tests.test_remap import load_projects


# Activate fixtures
assert check_hcv_db is not None
assert DEFAULT_DATABASE is not None
assert load_projects is not None


@pytest.fixture()
def exact_aligner(monkeypatch):
    from micall.tests.utils import mock_align_consensus

    monkeypatch.setattr(
        "micall.utils.consensus_aligner.align_consensus", mock_align_consensus
    )


def test_remap_to_stitcher_integration(tmp_path, hcv_db, exact_aligner, projects):
    """Test full workflow: denovo contigs -> remap -> stitch with remap_counts.

    This integration test verifies that:
    1. map_to_contigs generates valid remap_counts.csv
    2. contig_stitcher can read and use that remap_counts.csv
    3. read counts are properly extracted and associated with contigs
    """
    test_path = os.path.dirname(__file__)

    # Input contigs CSV (from denovo step)
    contigs_csv_content = """\
ref,match,group_ref,contig
HIV1-B-FR-K03455-seed,0.95,HIV1-B-FR-K03455-seed,TGTACAAGACCCAACAACAATACAAGAAAAAGTATACATATAGGACCAGGGAGAGC
HIV1-B-FR-K03455-seed,0.90,HIV1-B-FR-K03455-seed,ATTTGCATGGAATAGGACCAGCACACCACCAGGACAGCGGGTTGAATTC
"""
    contigs_csv_path = tmp_path / "contigs.csv"
    contigs_csv_path.write_text(contigs_csv_content)

    # Output files from remap
    remap_csv = tmp_path / "remap.csv"
    remap_counts_csv = tmp_path / "remap_counts.csv"
    remap_conseq_csv = tmp_path / "remap_conseq.csv"
    unmapped1 = tmp_path / "unmapped1.fastq"
    unmapped2 = tmp_path / "unmapped2.fastq"

    # Run map_to_contigs with real FASTQ files
    with (
        open(contigs_csv_path) as contigs_file,
        open(remap_csv, "w") as remap_file,
        open(remap_counts_csv, "w") as remap_counts_file,
        open(remap_conseq_csv, "w") as remap_conseq_file,
        open(unmapped1, "w") as unmapped1_file,
        open(unmapped2, "w") as unmapped2_file,
    ):
        remap.map_to_contigs(
            os.path.join(test_path, "microtest", "1234A-V3LOOP_S1_L001_R1_001.fastq"),
            os.path.join(test_path, "microtest", "1234A-V3LOOP_S1_L001_R2_001.fastq"),
            contigs_file,
            remap_file,
            remap_counts_file,
            remap_conseq_file,
            unmapped1_file,
            unmapped2_file,
            work_path=str(tmp_path),
        )

    # Verify remap_counts.csv was created and has expected format
    assert remap_counts_csv.exists()
    remap_counts_data = remap_counts_csv.read_text()
    assert "type,count" in remap_counts_data
    assert "raw," in remap_counts_data
    assert "remap " in remap_counts_data or "remap-final " in remap_counts_data

    # Parse the remap counts to verify format
    with open(remap_counts_csv) as f:
        reader = csv.DictReader(f)
        rows = list(reader)
        assert len(rows) > 0, "remap_counts.csv should have data rows"

        # Check for raw count
        raw_rows = [r for r in rows if r["type"] == "raw"]
        assert len(raw_rows) == 1, "Should have exactly one raw count"

        # Check for remap counts (should have format "remap N-REF" or "remap-final N-REF")
        remap_rows = [r for r in rows if r["type"].startswith("remap")]
        assert len(remap_rows) > 0, "Should have at least one remap count"

        # Verify remap rows have the expected format
        for row in remap_rows:
            assert " " in row["type"], f"Remap type should have space: {row['type']}"
            parts = row["type"].split(" ", 1)
            assert parts[0].startswith("remap"), (
                f"Should start with 'remap': {row['type']}"
            )
            assert row["count"].isdigit(), f"Count should be numeric: {row['count']}"

    # Now use the remap_counts.csv with contig stitcher
    with (
        open(contigs_csv_path) as contigs_file,
        open(remap_counts_csv) as remap_counts_file,
    ):
        # Read remap counts
        contig_read_counts = stitcher.read_remap_counts(remap_counts_file)

        # Verify we extracted some counts
        assert len(contig_read_counts) > 0, (
            "Should extract read counts from remap_counts.csv"
        )

        # Read and stitch contigs with read counts
        contigs = list(stitcher.read_contigs(contigs_file, contig_read_counts))

        # Verify contigs have reads_count populated
        for contig in contigs:
            # At least some contigs should have reads_count set
            # (some might be None if they weren't in remap_counts.csv)
            if contig.name in contig_read_counts:
                assert contig.reads_count is not None, (
                    f"Contig {contig.name} should have reads_count from remap_counts.csv"
                )
                assert contig.reads_count > 0, (
                    f"Contig {contig.name} should have positive reads_count"
                )


def test_read_remap_counts_various_formats():
    """Test read_remap_counts with various remap_counts.csv formats."""

    # Test case 1: Standard format from map_to_contigs
    remap_counts_1 = StringIO("""\
type,count,filtered_count,seed_dist,other_dist,other_seed
raw,1000,,,,
remap 1-HIV1-B-FR-K03455-seed,450,,,,
remap 2-HIV1-B-FR-K03455-seed,480,,,,
remap-final 1-HIV1-B-FR-K03455-seed,500,,,,
remap-final 2-HIV1-B-FR-K03455-seed,450,,,,
unmapped,50,,,,
""")

    counts = stitcher.read_remap_counts(remap_counts_1)

    # Should extract all remap entries
    assert "1-HIV1-B-FR-K03455-seed" in counts
    assert "2-HIV1-B-FR-K03455-seed" in counts

    # Should use the last occurrence (remap-final)
    assert counts["1-HIV1-B-FR-K03455-seed"] == 500
    assert counts["2-HIV1-B-FR-K03455-seed"] == 450

    # Should not include raw or unmapped
    assert "raw" not in counts
    assert "unmapped" not in counts

    # Test case 2: Format with remap-1, remap-2 iterations
    remap_counts_2 = StringIO("""\
type,count
raw,2000
remap-1 1-HCV-1a,300
remap-1 2-HCV-1a,250
remap-2 1-HCV-1a,320
remap-2 2-HCV-1a,270
remap-final 1-HCV-1a,350
remap-final 2-HCV-1a,280
unmapped,100
""")

    counts = stitcher.read_remap_counts(remap_counts_2)

    # Should use final counts
    assert counts["1-HCV-1a"] == 350
    assert counts["2-HCV-1a"] == 280

    # Test case 3: Minimal format (just type and count)
    remap_counts_3 = StringIO("""\
type,count
raw,5000
remap 1-SARSCOV2,2000
remap 2-SARSCOV2,1500
unmapped,500
""")

    counts = stitcher.read_remap_counts(remap_counts_3)
    assert counts["1-SARSCOV2"] == 2000
    assert counts["2-SARSCOV2"] == 1500


def test_read_remap_counts_edge_cases():
    """Test read_remap_counts with edge cases and malformed data."""

    # Test case 1: Empty file
    empty_csv = StringIO("type,count\n")
    counts = stitcher.read_remap_counts(empty_csv)
    assert counts == {}

    # Test case 2: No remap entries
    no_remap = StringIO("""\
type,count
raw,1000
unmapped,100
""")
    counts = stitcher.read_remap_counts(no_remap)
    assert counts == {}

    # Test case 3: Missing count column (should handle gracefully)
    missing_count = StringIO("""\
type,filtered_count
remap 1-HIV,
""")
    counts = stitcher.read_remap_counts(missing_count)
    # Should default to 0 when count is missing
    assert counts.get("1-HIV", 0) == 0

    # Test case 4: Non-numeric count (should raise ValueError)
    invalid_count = StringIO("""\
type,count
remap 1-HIV,not_a_number
""")

    with pytest.raises(ValueError, match="Invalid count value"):
        stitcher.read_remap_counts(invalid_count)

    # Test case 5: Malformed type field (no space after remap)
    malformed_type = StringIO("""\
type,count
remap,100
remap1-HIV,200
""")
    counts = stitcher.read_remap_counts(malformed_type)
    # Should not extract counts from malformed entries
    assert counts == {}

    # Test case 6: Zero counts
    zero_counts = StringIO("""\
type,count
raw,1000
remap 1-HIV,0
remap 2-HIV,100
remap 3-HIV,0
""")
    counts = stitcher.read_remap_counts(zero_counts)
    # Zero counts should still be included
    assert counts["1-HIV"] == 0
    assert counts["2-HIV"] == 100
    assert counts["3-HIV"] == 0


def test_read_remap_counts_contig_name_variations():
    """Test that read_remap_counts handles various contig naming patterns."""

    # Test different contig naming patterns
    remap_counts = StringIO("""\
type,count
remap 1-HIV1-B-FR-K03455-seed,100
remap 2-HIV1-B-FR-K03455-seed,200
remap 1-HCV-1a,150
remap 10-SARSCOV2,50
remap 100-complex-name-with-dashes,75
""")

    counts = stitcher.read_remap_counts(remap_counts)

    assert counts["1-HIV1-B-FR-K03455-seed"] == 100
    assert counts["2-HIV1-B-FR-K03455-seed"] == 200
    assert counts["1-HCV-1a"] == 150
    assert counts["10-SARSCOV2"] == 50
    assert counts["100-complex-name-with-dashes"] == 75


def test_read_remap_counts_duplicate_contigs():
    """Test handling of duplicate contig names (last one wins)."""

    remap_counts = StringIO("""\
type,count
remap 1-HIV,100
remap 1-HIV,200
remap 1-HIV,300
""")

    counts = stitcher.read_remap_counts(remap_counts)

    # Last occurrence should win
    assert counts["1-HIV"] == 300


def test_contig_stitcher_with_missing_remap_counts(exact_aligner, hcv_db):
    """Test that contig_stitcher handles contigs not in remap_counts.csv gracefully."""

    contigs_csv = StringIO("""\
ref,match,group_ref,contig
HIV1-B-FR-K03455-seed,0.95,HIV1-B-FR-K03455-seed,TGTACAAGACCCAACAACAATACAAGAAAAAGTATACATATAGGACCAGGGAGAGC
HIV1-B-FR-K03455-seed,0.90,HIV1-B-FR-K03455-seed,ATTTGCATGGAATAGGACCAGCACACCACCAGGACAGCGGGTTGAATTC
""")

    # Remap counts only has one of the two contigs
    remap_counts_csv = StringIO("""\
type,count
raw,1000
remap 1-HIV1-B-FR-K03455-seed,500
unmapped,100
""")

    contig_read_counts = stitcher.read_remap_counts(remap_counts_csv)
    contigs = list(stitcher.read_contigs(contigs_csv, contig_read_counts))

    # First contig should have reads_count, second should have None
    assert len(contigs) == 2
    assert contigs[0].reads_count == 500
    assert contigs[1].reads_count is None  # Not in remap_counts


def test_contig_stitcher_with_extra_remap_counts(exact_aligner, hcv_db):
    """Test that extra entries in remap_counts.csv don't cause issues."""

    contigs_csv = StringIO("""\
ref,match,group_ref,contig
HIV1-B-FR-K03455-seed,0.95,HIV1-B-FR-K03455-seed,TGTACAAGACCCAACAACAATACAAGAAAAAGTATACATATAGGACCAGGGAGAGC
""")

    # Remap counts has many contigs not in the contigs.csv
    remap_counts_csv = StringIO("""\
type,count
raw,1000
remap 1-HIV1-B-FR-K03455-seed,200
remap 2-HIV1-B-FR-K03455-seed,150
remap 3-HCV-1a,100
remap 4-SARSCOV2,50
unmapped,100
""")

    contig_read_counts = stitcher.read_remap_counts(remap_counts_csv)
    contigs = list(stitcher.read_contigs(contigs_csv, contig_read_counts))

    # Should only use the relevant count
    assert len(contigs) == 1
    assert contigs[0].reads_count == 200
